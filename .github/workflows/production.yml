name: ngmkt production deploy

on:
  push:
    branches:
      - main

jobs:
  test-sftp:
    name: Test SFTP Connection and Deploy to Multiple Folders
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Set up SSH key
      - name: Set up SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.FTP_HOST }} >> ~/.ssh/known_hosts

      # Step 3: Identify changed folders
      - name: Identify Changed Folders
        id: detect-changes
        run: |
          CHANGED_FOLDERS=$(git diff --dirstat=files,0 HEAD^ HEAD | cut -d'/' -f1 | sort -u | grep -E 'amasemporium|bingoml|edzain|ugbommaintefarms|dreambarbers|24hrs' || echo "")
          echo "CHANGED_FOLDERS=$CHANGED_FOLDERS" >> $GITHUB_ENV
          if [ -z "$CHANGED_FOLDERS" ]; then
            echo "No changes detected. Skipping deployment."
            exit 0
          fi

      # Step 4: Check if remote folder is up-to-date
      - name: Check if Remote Folder is Up-to-Date (amasemporium/api)
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_HOST }} \
          "cd /home/ngmktsit/www/business_sites/amasemporium/api && git fetch && git diff --quiet || exit 1"
        continue-on-error: true

      # Step 5: Upload files using Rsync
      - name: Upload Files Using Rsync
        if: success()
        run: |
          rsync -azP --delete \
          -e "ssh -o StrictHostKeyChecking=no" ./ \
          ${{ secrets.FTP_USERNAME }}@${{ secrets.FTP_HOST }}:/home/ngmktsit/www/business_sites/amasemporium/api/

      # Step 6: Run PHP Artisan Commands
      - name: Run PHP Artisan Command on amasemporium/api
        if: success()
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/ngmktsit/www/business_sites/amasemporium/api
            php artisan migrate --force
            php artisan optimize:clear
